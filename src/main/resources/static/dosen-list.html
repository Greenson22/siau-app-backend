<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Dosen</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #6f42c1;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        header h2 { margin: 0; color: #1c1e21; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th, td { padding: 0.75rem 1rem; text-align: left; border: 1px solid #dddfe2; }
        th { background-color: #f0f2f5; }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-right: 5px;
            color: white !important;
            font-weight: bold;
        }
        .btn-sm { font-size: 0.8em; padding: 5px 10px; }
        .btn-info { background-color: #17a2b8; }
        .btn-warning { background-color: #ffc107; color: #212529 !important;}
        .btn-secondary { background-color: #6c757d; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: bold; }
        .form-group input, .form-group textarea { width: 100%; padding: .5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #dosenDetailContent p { margin: 8px 0; }
        #dosenDetailContent p strong { color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h2 id="pageTitle">Daftar Dosen</h2>
            <a href="index.html" class="btn btn-secondary">Kembali ke Profil</a>
        </header>

        <div id="loading" style="display: none;">Memuat data...</div>
        
        <div id="admin-content">
            <table id="dosenTable">
                <thead>
                    <tr>
                        <th>NIDN</th>
                        <th>Nama Lengkap</th>
                        <th>Jurusan</th>
                        <th>Spesialisasi</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('detailModal')">&times;</span>
            <h3>Detail Dosen</h3>
            <div id="dosenDetailContent"></div>
        </div>
    </div>

    <div id="biodataModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('biodataModal')">&times;</span>
            <h3 id="biodataModalTitle">Update Biodata Dosen</h3>
            <form id="biodataForm">
                <input type="hidden" id="biodataDosenId">
                <div class="form-group">
                    <label for="alamat">Alamat</label>
                    <textarea id="alamat" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="nomorTelepon">Nomor Telepon</label>
                    <input type="tel" id="nomorTelepon">
                </div>
                <div class="form-group">
                    <label for="emailPribadi">Email Pribadi</label>
                    <input type="email" id="emailPribadi">
                </div>
                <div class="form-group">
                    <label for="spesialisasi">Spesialisasi</label>
                    <input type="text" id="spesialisasi">
                </div>
                <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            </form>
        </div>
    </div>

<script>
    const API_BASE = '/api';
    let jwtToken = null;

    document.addEventListener('DOMContentLoaded', async () => {
        jwtToken = sessionStorage.getItem('jwtToken');
        if (!jwtToken) {
            window.location.href = 'index.html';
            return;
        }

        try {
            const profile = await fetchData(`${API_BASE}/auth/me`);
            if (profile.role !== 'Admin') {
                document.body.innerHTML = '<h1>Akses Ditolak. Halaman ini hanya untuk Admin.</h1>';
                return;
            }
            loadDosen();
            document.getElementById('biodataForm').addEventListener('submit', handleUpdateBiodata);

        } catch (error) {
            console.error("Gagal memuat profil:", error);
            window.location.href = 'index.html';
        }
    });

    async function loadDosen() {
        const data = await fetchData(`${API_BASE}/dosen`);
        const tableBody = document.querySelector("#dosenTable tbody");
        tableBody.innerHTML = '';
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5">Data dosen tidak ditemukan.</td></tr>';
        } else {
            data.forEach(dosen => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${dosen.nidn}</td>
                        <td>${dosen.namaLengkap}</td>
                        <td>${dosen.namaJurusan || '-'}</td>
                        <td>${dosen.spesialisasi || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showDetail(${dosen.dosenId})">Detail</button>
                            <button class="btn btn-sm btn-warning" onclick="openBiodataModal(${dosen.dosenId},'${dosen.namaLengkap}')">Update Biodata</button>
                        </td>
                    </tr>
                `;
            });
        }
    }

    async function showDetail(dosenId) {
        const data = await fetchData(`${API_BASE}/dosen/${dosenId}`);
        const contentDiv = document.getElementById('dosenDetailContent');
        contentDiv.innerHTML = `
            <p><strong>ID Dosen:</strong> ${data.dosenId}</p>
            <p><strong>NIDN:</strong> ${data.nidn}</p>
            <p><strong>Nama Lengkap:</strong> ${data.namaLengkap}</p>
            <p><strong>Jurusan:</strong> ${data.namaJurusan}</p>
            <p><strong>Spesialisasi:</strong> ${data.spesialisasi || 'Belum diisi'}</p>
        `;
        openModal('detailModal');
    }
    
    function openBiodataModal(dosenId, namaLengkap) {
        document.getElementById('biodataForm').reset();
        document.getElementById('biodataDosenId').value = dosenId;
        document.getElementById('biodataModalTitle').textContent = `Update Biodata - ${namaLengkap}`;
        openModal('biodataModal');
    }

    async function handleUpdateBiodata(e) {
        e.preventDefault();
        const dosenId = document.getElementById('biodataDosenId').value;
        const payload = {
            alamat: document.getElementById('alamat').value,
            nomorTelepon: document.getElementById('nomorTelepon').value,
            emailPribadi: document.getElementById('emailPribadi').value,
            spesialisasi: document.getElementById('spesialisasi').value
        };

        try {
            await sendData(`${API_BASE}/dosen/${dosenId}/biodata`, 'PUT', payload);
            alert('Biodata dosen berhasil diperbarui!');
            closeModal('biodataModal');
            loadDosen(); // Muat ulang data tabel untuk melihat perubahan
        } catch (error) {
            alert(`Gagal memperbarui biodata: ${error.message}`);
        }
    }
    
    // --- FUNGSI BANTU (UTILITIES) ---
    async function fetchData(url) {
        document.getElementById('loading').style.display = 'block';
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${jwtToken}` } });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) window.location.href = 'index.html';
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return await response.json();
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function sendData(url, method, body) {
        const response = await fetch(url, {
            method: method,
            headers: { 'Authorization': `Bearer ${jwtToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Request gagal.' }));
            throw new Error(errorData.message);
        }
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            return response.json();
        } else {
            return response.text();
        }
    }

    function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
</script>
</body>
</html>